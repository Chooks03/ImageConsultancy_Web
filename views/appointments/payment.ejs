<% layout('../layout') -%>

<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center mb-8">
            <a href="/appointments/book" class="text-gray-600 hover:text-gray-800 mr-4">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-3xl font-bold gradient-text">Complete Payment</h1>
        </div>
        
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Booking Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Booking Summary</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div>
                            <h3 class="font-semibold text-lg"><%= service.name %></h3>
                            <p class="text-gray-600 text-sm"><%= service.description %></p>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Duration:</span>
                                <span><%= service.duration %> minutes</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Date:</span>
                                <span><%= formattedDate %></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Time:</span>
                                <span><%= formattedTime %></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Consultant:</span>
                                <span>Sriharshavardhini</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center text-lg font-semibold">
                            <span>Total Amount:</span>
                            <span class="text-rose-600">₹<%= service.price %></span>
                        </div>
                    </div>
                    
                    <div class="flex items-center text-xs text-gray-500 mt-4">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Secure payment powered by industry standards
                    </div>
                </div>
            </div>
            
            <!-- Payment Methods -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Select Payment Method</h2>
                    
                    <form id="payment-form">
                        <div class="space-y-4 mb-6">
                            <div class="payment-method border rounded-lg p-4 cursor-pointer hover:border-rose-500 transition-colors" data-method="card">
                                <div class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="card" class="text-rose-600">
                                    <i class="fas fa-credit-card text-xl text-gray-600"></i>
                                    <div>
                                        <h3 class="font-semibold">Credit/Debit Card</h3>
                                        <p class="text-sm text-gray-500">Visa, Mastercard, RuPay</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-method border rounded-lg p-4 cursor-pointer hover:border-rose-500 transition-colors" data-method="upi">
                                <div class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="upi" class="text-rose-600">
                                    <i class="fas fa-mobile-alt text-xl text-gray-600"></i>
                                    <div>
                                        <h3 class="font-semibold">UPI</h3>
                                        <p class="text-sm text-gray-500">Google Pay, PhonePe, Paytm</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-method border rounded-lg p-4 cursor-pointer hover:border-rose-500 transition-colors" data-method="netbanking">
                                <div class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="netbanking" class="text-rose-600">
                                    <i class="fas fa-university text-xl text-gray-600"></i>
                                    <div>
                                        <h3 class="font-semibold">Net Banking</h3>
                                        <p class="text-sm text-gray-500">All major banks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Details Forms -->
                        <div id="card-details" class="payment-details hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                            <h3 class="font-semibold">Card Details</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name</label>
                                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                    <input type="text" placeholder="1234 5678 9012 3456" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                    <input type="text" placeholder="MM/YY" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                                    <input type="text" placeholder="123" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                </div>
                            </div>
                        </div>
                        
                        <div id="upi-details" class="payment-details hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                            <h3 class="font-semibold">UPI Details</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">UPI ID</label>
                                <input type="text" placeholder="yourname@paytm" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                            </div>
                        </div>
                        
                        <div id="netbanking-details" class="payment-details hidden space-y-4 p-4 border rounded-lg bg-gray-50">
                            <h3 class="font-semibold">Net Banking</h3>
                            <p class="text-sm text-gray-600">You will be redirected to your bank's website to complete the payment.</p>
                        </div>
                        
                        <button type="submit" id="pay-button" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity mt-6">
                            <span id="pay-text">Pay ₹<%= service.price %></span>
                            <span id="processing-text" class="hidden">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Processing Payment...
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Payment method selection
document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
        const methodType = this.dataset.method;
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        
        // Hide all payment details
        document.querySelectorAll('.payment-details').forEach(detail => {
            detail.classList.add('hidden');
        });
        
        // Show selected payment details
        document.getElementById(methodType + '-details').classList.remove('hidden');
        
        // Update styling
        document.querySelectorAll('.payment-method').forEach(pm => {
            pm.classList.remove('border-rose-500', 'bg-rose-50');
        });
        this.classList.add('border-rose-500', 'bg-rose-50');
    });
});

// Form submission
document.getElementById('payment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    if (!paymentMethod) {
        alert('Please select a payment method');
        return;
    }
    
    // Show processing state
    document.getElementById('pay-text').classList.add('hidden');
    document.getElementById('processing-text').classList.remove('hidden');
    document.getElementById('pay-button').disabled = true;
    
    try {
        const response = await fetch('/appointments/process-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                serviceId: <%= service.id %>,
                date: '<%= appointmentDate.toISOString() %>',
                paymentMethod: paymentMethod.value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = '/appointments?success=true';
        } else {
            throw new Error(result.error || 'Payment failed');
        }
    } catch (error) {
        alert('Payment failed: ' + error.message);
        
        // Reset button state
        document.getElementById('pay-text').classList.remove('hidden');
        document.getElementById('processing-text').classList.add('hidden');
        document.getElementById('pay-button').disabled = false;
    }
});
</script>
